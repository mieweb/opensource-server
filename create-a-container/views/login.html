<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MIE Container Creation Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="/style.css" rel="stylesheet">
</head>
<body>
    <div class="login-container">
        <img src="logo.png" alt="Company Logo" class="logo">
        <h2>Container Creation Login</h2>
        <form method="POST" action="/login" id="loginForm">
            <label for="username">Proxmox Username</label>
            <input type="text" name="username" id="username" required>

            <label for="password">Proxmox Password</label>
            <input type="password" name="password" id="password" required>

            <input type="submit" value="Login">
        </form>
        <hr>
        <div class="signup-section">
            <h2>Dont have an account?</h2>
            <button id="signUpBtn">Request an Account</button>
        </div>
        <div id="errorMessage" style="color:red;"></div>
        <div class="footer">
            &copy; 2025 Medical Informatics Engineering
        </div>
    </div>
</body>
</html>
<script>
document.getElementById('loginForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const formData = new FormData(this);
  const username = formData.get('username');
  const password = formData.get('password');
  const errorMessageDiv = document.getElementById('errorMessage');

  try {
    // If the page was visited with a ?redirect= URL param, include it in the POST so the server can redirect after login
    const urlParams = new URLSearchParams(window.location.search);
    const redirect = urlParams.get('redirect') || '/';

    const res = await fetch('/login?redirect=' + encodeURIComponent(redirect), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ username, password, redirect })
    });

    // First, check if the HTTP response status is successful
    if (res.ok) {
      const data = await res.json(); // Now it's safe to parse JSON
      if (data.redirect) {
        window.location.href = data.redirect;
      } else {
        errorMessageDiv.textContent = "Login successful, but no redirect URL was provided.";
      }
    } else {
      // If the response is not ok (e.g., status 401), it's a failed login.
      // Display a user-friendly error instead of trying to parse the (likely HTML) body.
      errorMessageDiv.textContent = "Invalid username or password.";
      // You can also log the status for debugging
      console.error("Login failed with status:", res.status);
    }
  } catch (err) {
    // This will now only catch network errors or other unexpected issues.
    console.error("Fetch error:", err);
    errorMessageDiv.textContent = "A network error occurred. Please try again.";
  }
});

document.getElementById('signUpBtn').addEventListener('click', () => {
  window.location.href = '/request-account.html';
});
</script>
