<%
const isEdit = typeof container !== 'undefined' && container;
const pageTitle = isEdit ? 'Edit Container Services' : 'Create Your Container';
const formAction = isEdit ? `/sites/${site.id}/containers/${container.id}` : `/sites/${site.id}/containers`;
const breadcrumbLabel = isEdit ? 'Edit' : 'New';
%>
<%- include('../layouts/header', { 
  title: pageTitle + ' - MIE',
  breadcrumbs: [
    { label: 'Sites', url: '/sites' },
    { label: site.name, url: `/sites/${site.id}/containers` },
    { label: breadcrumbLabel, url: null }
  ],
  colWidth: 'col-12 col-lg-10',
  req
}) %>

<div class="login-container" style="max-width: 900px;">
  <img src="/logo.png" alt="Company Logo" class="logo">
  <h2><%= pageTitle %></h2>
  <form id="containerForm" method="POST" action="<%= formAction %>">
    <% if (isEdit) { %>
      <input type="hidden" name="_method" value="PUT">
    <% } else { %>
      <input type="hidden" name="init" value="true">
    <% } %>
    
    <div style="display: flex; gap: 15px; margin-bottom: 15px;">
      <div style="flex: 1;">
        <label for="hostname">Container Hostname</label>
        <input type="text" id="hostname" name="hostname" value="<%= isEdit ? container.hostname : '' %>" <%= isEdit ? 'readonly' : 'required' %> <%= isEdit ? 'style="background-color: #e9ecef;"' : '' %>>
      </div>
      
      <div style="flex: 1;">
        <label for="template">Container Template</label>
        <% if (isEdit) { %>
          <input type="text" id="template" value="<%= container.template %>" readonly style="background-color: #e9ecef;">
        <% } else { %>
          <select id="templateSelect" name="template" required>
            <option value="">Select a template...</option>
            <% if (typeof templates !== 'undefined' && templates && templates.length > 0) { %>
              <% templates.forEach(template => { %>
                <option value="<%= template.node %>,<%= template.vmid %>">
                  <%= template.name %> (<%= template.node %>)
                </option>
              <% }) %>
            <% } %>
            <option value="custom">Custom Docker Image...</option>
          </select>
          <div id="customTemplateContainer" style="display: none; margin-top: 8px;">
            <input type="text" id="customTemplate" name="customTemplate" 
                   placeholder="ghcr.io/org/image:tag"
                   style="width: 100%;">
            <small style="color: #666; display: block; margin-top: 4px;">
              Format: [registry/][org/]image[:tag] â€” defaults: registry=docker.io, org=library, tag=latest
            </small>
          </div>
        <% } %>
      </div>
    </div>

    <details style="margin-bottom: 15px;">
      <summary style="cursor: pointer; font-weight: bold; padding: 8px 0; border-bottom: 1px solid #ddd; margin-bottom: 10px; text-align: left;">
        Services
      </summary>
      <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
        <button type="button" id="addServiceBtn" class="btn btn-sm btn-primary">Add Service</button>
      </div>
      <div>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Type</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Internal Port</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">
                External
                <a href="#" 
                   tabindex="0" 
                   role="button"
                   data-bs-toggle="popover" 
                   data-bs-trigger="click"
                   data-bs-placement="top"
                   data-bs-html="true"
                   data-bs-title="External Field Guide"
                   data-bs-content="<strong>HTTP:</strong> Enter a hostname and select an external domain.<br><br><strong>TCP/UDP:</strong> External port will be autoassigned after creation.<br><br><strong>SRV:</strong> Enter service name in <code>_service._proto</code> format (e.g., <code>_ldap._tcp</code>). The internal domain is automatically appended."
                   onclick="event.preventDefault();"
                   style="text-decoration: none; margin-left: 5px; color: #0d6efd; cursor: pointer;">
                  <i class="bi bi-question-circle"></i>
                </a>
              </th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 60px;">Action</th>
            </tr>
          </thead>
          <tbody id="servicesTableBody">
            <!-- Services will be added here dynamically -->
          </tbody>
        </table>
      </div>
    </details>

    <details style="margin-bottom: 15px;">
      <summary style="cursor: pointer; font-weight: bold; padding: 8px 0; border-bottom: 1px solid #ddd; margin-bottom: 10px; text-align: left;">
        Environment Variables
      </summary>
      <div style="display: flex; justify-content: flex-end; margin-bottom: 10px;">
        <button type="button" id="addEnvBtn" class="btn btn-sm btn-primary">Add Variable</button>
      </div>
      <div>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Key</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: left;">Value</th>
              <th style="border: 1px solid #ddd; padding: 8px; text-align: center; width: 60px;">Action</th>
            </tr>
          </thead>
          <tbody id="envVarsTableBody">
            <!-- Environment variables will be added here dynamically -->
          </tbody>
        </table>
      </div>
    </details>

    <details style="margin-bottom: 15px;">
      <summary style="cursor: pointer; font-weight: bold; padding: 8px 0; border-bottom: 1px solid #ddd; margin-bottom: 10px; text-align: left;">
        Entrypoint Command
      </summary>
      <div class="mb-3">
        <input 
          type="text" 
          class="form-control" 
          id="entrypoint" 
          name="entrypoint" 
          value="<%= isEdit && container.entrypoint ? container.entrypoint : '' %>"
          placeholder="/sbin/init"
        >
        <div class="form-text">The command to run when the container starts (overrides the default entrypoint)</div>
      </div>
    </details>

    <input type="submit" value="<%= isEdit ? 'Update Container' : 'Create Container' %>">
  </form>
  <div id="formError" style="color:red; margin-top:10px;"></div>
</div>

<script>
  const isEdit = <%- isEdit ? 'true' : 'false' %>;
  const siteInternalDomain = <%- JSON.stringify(site.internalDomain || '') %>;
  const existingServices = <%- isEdit && container && container.services ? JSON.stringify(container.services.map(s => ({
    id: s.id,
    type: s.type,
    internalPort: s.internalPort,
    httpService: s.httpService ? {
      externalHostname: s.httpService.externalHostname,
      externalDomainId: s.httpService.externalDomainId
    } : null,
    transportService: s.transportService ? {
      protocol: s.transportService.protocol,
      externalPort: s.transportService.externalPort
    } : null,
    dnsService: s.dnsService ? {
      dnsName: s.dnsService.dnsName
    } : null
  }))) : '[]' %>;
  const externalDomains = <%- JSON.stringify((externalDomains || []).map(d => ({ id: d.id, name: d.name }))) %>;
  const existingEnvVars = <%- isEdit && container && container.environmentVars ? container.environmentVars : '{}' %>;
  let serviceCounter = 0;
  let envVarCounter = 0;

  // Custom template toggle logic
  const templateSelect = document.getElementById('templateSelect');
  const customTemplateContainer = document.getElementById('customTemplateContainer');
  const customTemplateInput = document.getElementById('customTemplate');
  
  if (templateSelect) {
    templateSelect.addEventListener('change', function() {
      if (this.value === 'custom') {
        customTemplateContainer.style.display = 'block';
        customTemplateInput.required = true;
        this.removeAttribute('name'); // Don't submit the select value
      } else {
        customTemplateContainer.style.display = 'none';
        customTemplateInput.required = false;
        customTemplateInput.value = '';
        this.setAttribute('name', 'template'); // Submit select value
      }
    });
  }

  function addServiceRow(type = 'http', internalPort = '', externalHostname = '', externalDomainId = '', serviceId = null, externalPort = null, dnsName = '') {
    const row = document.createElement('tr');
    row.id = `service-row-${serviceCounter}`;
    const isExisting = !!serviceId;
    
    // Hidden fields for serviceId and deleted flag
    if (serviceId) {
      const serviceIdInput = document.createElement('input');
      serviceIdInput.type = 'hidden';
      serviceIdInput.name = `services[${serviceCounter}][id]`;
      serviceIdInput.value = serviceId;
      row.appendChild(serviceIdInput);
    }
    
    const deletedInput = document.createElement('input');
    deletedInput.type = 'hidden';
    deletedInput.name = `services[${serviceCounter}][deleted]`;
    deletedInput.value = 'false';
    deletedInput.id = `service-deleted-${serviceCounter}`;
    row.appendChild(deletedInput);
    
    // Hidden field for external port (for transport services)
    if (externalPort) {
      const externalPortInput = document.createElement('input');
      externalPortInput.type = 'hidden';
      externalPortInput.name = `services[${serviceCounter}][externalPort]`;
      externalPortInput.value = externalPort;
      row.appendChild(externalPortInput);
    }
    
    // Type cell
    const typeCell = document.createElement('td');
    typeCell.style.cssText = 'border: 1px solid #ddd; padding: 8px;';
    
    const typeSelect = document.createElement('select');
    typeSelect.name = `services[${serviceCounter}][type]`;
    typeSelect.className = 'service-type';
    typeSelect.dataset.index = serviceCounter;
    typeSelect.required = true;
    typeSelect.disabled = isExisting;
    typeSelect.style.cssText = `width: 100%; padding: 4px; ${isExisting ? 'background-color: #e9ecef; cursor: not-allowed;' : ''}`;
    
    ['http', 'tcp', 'udp', 'srv'].forEach(optionType => {
      const option = document.createElement('option');
      option.value = optionType;
      option.textContent = optionType.toUpperCase();
      if (optionType === type) {
        option.selected = true;
      }
      typeSelect.appendChild(option);
    });
    
    typeCell.appendChild(typeSelect);
    
    // Internal port cell
    const internalPortCell = document.createElement('td');
    internalPortCell.style.cssText = 'border: 1px solid #ddd; padding: 8px;';
    
    const portInput = document.createElement('input');
    portInput.type = 'number';
    portInput.name = `services[${serviceCounter}][internalPort]`;
    portInput.value = internalPort;
    portInput.min = '1';
    portInput.max = '65535';
    portInput.required = true;
    portInput.disabled = isExisting;
    portInput.style.cssText = `width: 100%; padding: 4px; ${isExisting ? 'background-color: #e9ecef; cursor: not-allowed;' : ''}`;
    
    internalPortCell.appendChild(portInput);
    
    // External cell (will be populated by updateExternalCell)
    const externalCell = document.createElement('td');
    externalCell.style.cssText = 'border: 1px solid #ddd; padding: 8px;';
    externalCell.id = `external-cell-${serviceCounter}`;
    
    // Action cell
    const actionCell = document.createElement('td');
    actionCell.style.cssText = 'border: 1px solid #ddd; padding: 8px; text-align: center;';
    
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.id = `remove-btn-${serviceCounter}`;
    removeBtn.textContent = 'Delete';
    removeBtn.style.cssText = 'padding: 4px 8px; cursor: pointer; background-color: #dc3545; color: white; border: none; border-radius: 4px;';
    const currentIndex = serviceCounter; // Capture the current value
    removeBtn.onclick = () => toggleDeleteService(currentIndex);
    
    actionCell.appendChild(removeBtn);
    
    row.appendChild(typeCell);
    row.appendChild(internalPortCell);
    row.appendChild(externalCell);
    row.appendChild(actionCell);
    
    document.getElementById('servicesTableBody').appendChild(row);
    
    updateExternalCell(serviceCounter, type, externalHostname, externalDomainId, externalPort, isExisting, dnsName);
    serviceCounter++;
  }

  function updateExternalCell(index, type, hostname = '', domainId = '', externalPort = null, isExisting = false, dnsName = '') {
    const cell = document.getElementById(`external-cell-${index}`);
    
    // Clear existing content
    while (cell.firstChild) {
      cell.removeChild(cell.firstChild);
    }
    
    if (type === 'http') {
      // Auto-select first domain if no domain is specified
      if (!domainId && externalDomains.length > 0) {
        domainId = externalDomains[0].id;
      }
      
      const container = document.createElement('div');
      container.style.cssText = 'display: flex; gap: 5px; align-items: center;';
      
      const hostnameInput = document.createElement('input');
      hostnameInput.type = 'text';
      hostnameInput.name = `services[${index}][externalHostname]`;
      hostnameInput.value = hostname;
      hostnameInput.placeholder = 'hostname';
      hostnameInput.disabled = isExisting;
      hostnameInput.style.cssText = `flex: 1; padding: 4px; ${isExisting ? 'background-color: #e9ecef; cursor: not-allowed;' : ''}`;
      
      const dot = document.createElement('span');
      dot.textContent = '.';
      
      const domainSelect = document.createElement('select');
      domainSelect.name = `services[${index}][externalDomainId]`;
      domainSelect.disabled = isExisting;
      domainSelect.style.cssText = `flex: 1; padding: 4px; ${isExisting ? 'background-color: #e9ecef; cursor: not-allowed;' : ''}`;
      
      externalDomains.forEach(domain => {
        const option = document.createElement('option');
        option.value = domain.id;
        option.textContent = domain.name;
        if (domain.id == domainId) {
          option.selected = true;
        }
        domainSelect.appendChild(option);
      });
      
      container.appendChild(hostnameInput);
      container.appendChild(dot);
      container.appendChild(domainSelect);
      cell.appendChild(container);
    } else if (type === 'srv') {
      // SRV record - DNS name input with internal domain display
      const container = document.createElement('div');
      container.style.cssText = 'display: flex; gap: 5px; align-items: center;';
      
      const dnsNameInput = document.createElement('input');
      dnsNameInput.type = 'text';
      dnsNameInput.name = `services[${index}][dnsName]`;
      dnsNameInput.value = dnsName;
      dnsNameInput.placeholder = '_service._tcp';
      dnsNameInput.disabled = isExisting;
      dnsNameInput.style.cssText = `flex: 1; padding: 4px; ${isExisting ? 'background-color: #e9ecef; cursor: not-allowed;' : ''}`;
      
      const dot = document.createElement('span');
      dot.textContent = '.';
      
      const domainSpan = document.createElement('span');
      domainSpan.textContent = siteInternalDomain;
      domainSpan.style.cssText = 'padding: 4px; color: #666;';
      
      container.appendChild(dnsNameInput);
      container.appendChild(dot);
      container.appendChild(domainSpan);
      cell.appendChild(container);
    } else {
      // Transport services (tcp/udp)
      const input = document.createElement('input');
      input.type = 'text';
      input.value = externalPort ? externalPort : 'autoassign';
      input.disabled = true;
      input.style.cssText = 'width: 100%; padding: 4px; background-color: #e9ecef;';
      cell.appendChild(input);
    }
  }

  function toggleDeleteService(index) {
    const row = document.getElementById(`service-row-${index}`);
    const deletedInput = document.getElementById(`service-deleted-${index}`);
    const removeBtn = document.getElementById(`remove-btn-${index}`);
    
    if (!row || !deletedInput || !removeBtn) return;
    
    const isDeleted = deletedInput.value === 'true';
    
    if (isDeleted) {
      // Undo deletion
      deletedInput.value = 'false';
      row.style.opacity = '1';
      row.style.textDecoration = 'none';
      removeBtn.textContent = 'Delete';
      removeBtn.style.backgroundColor = '#dc3545';
    } else {
      // Mark for deletion
      deletedInput.value = 'true';
      row.style.opacity = '0.5';
      row.style.textDecoration = 'line-through';
      removeBtn.textContent = 'Undo';
      removeBtn.style.backgroundColor = '#6c757d';
    }
  }

  document.getElementById('addServiceBtn').addEventListener('click', () => {
    addServiceRow();
  });

  document.getElementById('servicesTableBody').addEventListener('change', (e) => {
    if (e.target.classList.contains('service-type')) {
      const index = e.target.dataset.index;
      const type = e.target.value;
      // Try to find existing external port from hidden field
      const row = document.getElementById(`service-row-${index}`);
      const externalPortInput = row?.querySelector('input[name*="[externalPort]"]');
      const externalPort = externalPortInput?.value || null;
      updateExternalCell(index, type, '', '', externalPort);
    }
  });

  // Initialize services
  const hostnameField = document.getElementById('hostname');
  
  if (isEdit && existingServices.length > 0) {
    // Load existing services when editing
    existingServices.forEach(service => {
      let type, externalHostname = '', externalDomainId = '', externalPort = null, dnsName = '';
      
      if (service.type === 'http') {
        type = 'http';
        externalHostname = service.httpService?.externalHostname || '';
        externalDomainId = service.httpService?.externalDomainId || '';
      } else if (service.type === 'dns') {
        type = 'srv';
        dnsName = service.dnsService?.dnsName || '';
      } else {
        // transport service
        type = service.transportService?.protocol || 'tcp';
        externalPort = service.transportService?.externalPort || null;
      }
      
      addServiceRow(type, service.internalPort, externalHostname, externalDomainId, service.id, externalPort, dnsName);
    });
  }
  
  // Update externalHostname when hostname field changes (only for new containers)
  if (!isEdit) {
    hostnameField.addEventListener('input', (e) => {
      // Update all HTTP service hostname inputs with the new hostname
      document.querySelectorAll('input[name*="[externalHostname]"]').forEach(input => {
        if (input.value === '' || input.placeholder === 'hostname') {
          input.value = e.target.value;
        }
      });
    });
  }

  // Environment Variables functionality
  function addEnvVarRow(key = '', value = '') {
    const row = document.createElement('tr');
    row.id = `env-row-${envVarCounter}`;
    
    // Key cell
    const keyCell = document.createElement('td');
    keyCell.style.cssText = 'border: 1px solid #ddd; padding: 8px;';
    
    const keyInput = document.createElement('input');
    keyInput.type = 'text';
    keyInput.name = `environmentVars[${envVarCounter}][key]`;
    keyInput.value = key;
    keyInput.placeholder = 'KEY_NAME';
    keyInput.pattern = '[A-Za-z_][A-Za-z0-9_]*';
    keyInput.style.cssText = 'width: 100%; padding: 4px;';
    
    keyCell.appendChild(keyInput);
    
    // Value cell
    const valueCell = document.createElement('td');
    valueCell.style.cssText = 'border: 1px solid #ddd; padding: 8px;';
    
    const valueInput = document.createElement('input');
    valueInput.type = 'text';
    valueInput.name = `environmentVars[${envVarCounter}][value]`;
    valueInput.value = value;
    valueInput.placeholder = 'value';
    valueInput.style.cssText = 'width: 100%; padding: 4px;';
    
    valueCell.appendChild(valueInput);
    
    // Action cell
    const actionCell = document.createElement('td');
    actionCell.style.cssText = 'border: 1px solid #ddd; padding: 8px; text-align: center;';
    
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.textContent = 'Delete';
    removeBtn.style.cssText = 'padding: 4px 8px; cursor: pointer; background-color: #dc3545; color: white; border: none; border-radius: 4px;';
    const currentIndex = envVarCounter;
    removeBtn.onclick = () => {
      document.getElementById(`env-row-${currentIndex}`).remove();
    };
    
    actionCell.appendChild(removeBtn);
    
    row.appendChild(keyCell);
    row.appendChild(valueCell);
    row.appendChild(actionCell);
    
    document.getElementById('envVarsTableBody').appendChild(row);
    envVarCounter++;
  }

  document.getElementById('addEnvBtn').addEventListener('click', () => {
    addEnvVarRow();
  });

  // Initialize existing environment variables
  if (existingEnvVars && typeof existingEnvVars === 'object') {
    for (const [key, value] of Object.entries(existingEnvVars)) {
      addEnvVarRow(key, value);
    }
  }
</script>

<%- include('../layouts/footer') %>
