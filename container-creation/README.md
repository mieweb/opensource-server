# Container Creation

## Scripts

- [`extract-fingerprint.sh`](./intern-phxdc-pve1/home-create-container-bin/extract-fingerprint.sh) - Executed via the [`sshd_config`](./intern-phxdc-pve1/etc-ssh/sshd_config) `ForceCommand` for the "create-container" user on intern-phxdc-pve1. Derives user's SSH pubkey fingerprint from the sshd journal, then forwards the `SSH_KEY_FP`, `PUBLIC_KEY`, `PROXMOX_USERNAME`, `PROXMOX_PASSWORD`, `CONTAINER_NAME`, `HTTP_PORT`, `DEPLOY_ON_START`, `PROJECT_REPOSITORY`, `PROJECT_BRANCH`, `PROJECT_ROOT`, `REQUIRE_ENV_VARS`, `CONTAINER_ENV_VARS`, `INSTALL_COMMAND`, `BUILD_COMMAND`, `START_COMMAND`, `RUNTIME_LANGUAGE`, `SERVICES`, `REQUIRE_SERVICES`, `CUSTOM_SERVICES`, `LINUX_DISTRIBUTION`, `MULTI_COMPONENT`, `ROOT_START_COMMAND`, `GH_ACTION`, `GITHUB_PAT` and `SELF_HOSTED_RUNNER` environment variables to the ssh as "create-container" on the container-creation server.
- [`create-lxc-container.sh`](./container-creation/root-bin/create-lxc-container.sh) - Executed via the [`sshd_config`](./container-creation/etc-ssh/sshd_config) `ForceCommand` for the "create-container" user on container-creation. Queries for `PROXMOX_USERNAME`, `PROXMOX_PASSWORD` if unset in the environment, then verifies them with the [`runner.js`](./container-creation/root-bin/js/runner.js) subcommand `authenticateUser`. If authentication fails, the user is re-prompted unless the `GH_ACTION` environment variable is set, in which case the script fails fast. The script then prompts for `CONTAINER_NAME` if unset in the environment, then checks if that name is available with the [`checkHostnameRunner.js`](../nginx-reverse-proxy/checkHostnameRunner.js) script on the NGINX server. Again, the script re-prompts until a valid hostname is given unles `GH_ACTION` is set in the environment. The script then attempts to detect an SSH Public Key using the [`detectPublicKey.sh`](./container-creation/root-bin/ssh/detectPublicKey.sh) script and if it is not found, check if `PUBLIC_KEY` is unset, and otherwise prompt or fail depending on `GH_ACTION`. Once a public key is identified, it is handled with the [`publicKeyAppendJumpHost.sh`](./container-creation/root-bin/ssh/publicKeyAppendJumpHost.sh) script. Likewise, `HTTP_PORT` is prompted based on it's value and `GH_ACTION`. Then the user is prompted for additional protocols to be forwarded to the container cross-referenced with [`master_protocol_list.txt`](./container-creation/root-bin/protocols/master_protocol_list.txt). `DEPLOY_ON_START` is then prompted based on the value of `GH_ACTION`. If it is set, the [`deploy-application.sh`](./container-creation/root-bin/deploy-application.sh) script is invoked before continuing. Several files are then copied to intern-phxdc-pve1 before [`create-container.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/create-container.sh) is invoked as root on intern-phxdc-pve1.
- [`deploy-application.sh`](./container-creation/root-bin/deploy-application.sh) - This script prompts for the `PROJECT_REPOSITORY`, `PROJECT_BRANCH`, `PROJECT_ROOT`, `RUNTIME_LANGUAGE`, `MULTI_COMPONENT`, and `COMPONENT_PATH` variables if they are unset, failing early if `GH_ACTION` is defined. Each stage verfies the existence with the `authenticateRepo` subcommand of [`runner.js`](./container-creation/root-bin/js/runner.js). Several more variables are set using the [`gatherSetupCommands.sh`](./container-creation/root-bin/deployment-scripts/gatherSetupCommands.sh), [`gatherEnvVars.sh`](./container-creation/root-bin/deployment-scripts/gatherEnvVars.sh), [`gatherRuntimeLangs.sh`](./container-creation/root-bin/deployment-scripts/gatherRuntimeLangs.sh) and [`gatherServices.sh`](./container-creation/root-bin/deployment-scripts/gatherRuntimeLangs.sh) scripts.
- [`gatherSetupCommands.sh`](./container-creation/root-bin/deployment-scripts/gatherSetupCommands.sh) - used to prompt for the `BUILD_COMMAND`, `INSTALL_COMMAND`, `START_COMMAND`, and `ROOT_START_COMMAND` (if `MUTLI_COMPONENT`) variables if they are unset.
- [`gatherEnvVars.sh`](./container-creation/root-bin/deployment-scripts/gatherEnvVars.sh) - used to prompt for the `REQUIRE_ENV_VARS` and `CONTAINER_ENV_VARS` then prompts for environment variables and their values to store in `/root/bin/env/env_{100000-999999}/{component_path}.txt`
- [`gatherRuntimeLangs.sh`](./container-creation/root-bin/deployment-scripts/gatherRuntimeLangs.sh) - Prompts for the `RUNTIME_LANGUAGE` variable for each component. Support values include `nodejs` and `python` with a version number for both.
- [`gatherServices.sh`](./container-creation/root-bin/deployment-scripts/gatherRuntimeLangs.sh) - sets the `REQUIRE_SERVICES` variable, and, if true, appends services to the `/root/bin/services/services_{100000-999999}.txt` file which is a list of commands to run to start the services.
- [`create-container.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/create-container.sh) - Clones the container template for the `LINUX_DISTRO`, sets the `PROXMOX_USERNAME` tag, starts the container, adds `PROXMOX_USERNAME` as a user on the container, stores the `CONTAINER_ID`, adds the user's ssh public key, to root's authorized_keys, sets a random root password, stores `CONTAINER_IP` (allocated from DHCP but obtained from `hostname -I`), runs [`configureLDAP.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/helper-scripts/configureLDAP.sh), runs [`register-agent.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/helper-scripts/register-agent.sh), runs [`deployOnStart.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/helper-scripts/deployOnStart.sh), runs [`register-container.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/register-container.sh), displays the container's details, then runs [`start_services.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/start_services.sh) in a TMUX.
- [`configureLDAP.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/helper-scripts/configureLDAP.sh) - Runs https://raw.githubusercontent.com/anishapant21/pown.sh/main/pown.sh on thhe server, then makes a few additional changes the sssd.
- [`register-agent.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/helper-scripts/register-agent.sh) - Installs wazuh-agent from it's repos then registers it with the manager.
- [`deployOnStart.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/helper-scripts/deployOnStart.sh) - clones `PROJECT_REPOSITORY` to /root on the container, then copies each set of env vars from `gatherEnvVars.sh` to the appropriate component directories, then calls the appropriate [`node_runtime_install`](./intern-phxdc-pve1/var-lib-vz-snippets/helper-scripts/node_runtime_install.sh) or [`python_runtime_install`](./intern-phxdc-pve1/var-lib-vz-snippets/helper-scripts/python_runtime_install.sh) scripts for component runtimes, then runs `INSTALL_CMD` and executes the file created in `gatherServices.sh`
- [`register-container.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/register-container.sh) - interogates for `container_ip`, `hostname`, `os_release`, and `mac`, then checks if an SSH port forwards has already been allocated via IPTables on intern-phxdc-pve1 and allocates one if not. Similarly checks then allocates additional port-forwards also via IPTables on intern-phxdc-pve1. Then `port_map.json`is updated via an ssh connection to the NGINX container using `jq` to perform the update.
- [`start_services.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/start_services.sh) - Stops `CONTAINER_ID`, sources [`create-template.sh`](./intern-phxdc-pve1/var-lib-vz-snippets/helper-scripts/create-template.sh), starts `CONTAINER_ID`, starts `github-runner.service` in the container if `GH_ACTION`, runs `BUILD_COMMAND`, then `START_COMMAND` for each component and `ROOT_START_COMMAND` when `MULTI_COMPONENT`.