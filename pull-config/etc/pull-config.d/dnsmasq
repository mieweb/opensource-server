#!/usr/bin/env bash
# Dnsmasq instance configuration for pull-config

# Export well-formed KEY=VALUE lines from /etc/environment (safe for unquoted values)
while IFS='=' read -r key value; do
  [[ -z "$key" || "$key" =~ ^# ]] && continue
  export "$key=$value"
done < /etc/environment

if [[ -z "${SITE_ID:-}" ]] || [[ -z "${MANAGER_URL:-}" ]]; then
  echo "ERROR: SITE_ID and MANAGER_URL must be set in /etc/environment" >&2
  exit 1
fi

# Configuration file to manage
export CONF_FILE=/etc/dnsmasq.conf

# URL to fetch configuration from
export CONF_URL=${MANAGER_URL}/sites/${SITE_ID}/dnsmasq.conf

# Command to test configuration validity before applying
export TEST_COMMAND="dnsmasq --test"

# Command to reload the service (empty means use SERVICE_NAME fallback)
# We manually restart dnsmasq becuase it implements a systemd reload handler
# that doesn't actually pick up configuration changes.
export RELOAD_COMMAND="systemctl restart dnsmasq"

# Service name for systemctl reload-or-restart
export SERVICE_NAME=""

# Execute pull-config
exec /opt/opensource-server/pull-config/bin/pull-config

