#!/usr/bin/env bash
# Nginx instance configuration for pull-config

# Source environment variables (SITE_ID, MANAGER_URL, API_KEY)
set -a; . /etc/environment; set +a

if [[ -z "${SITE_ID:-}" ]] || [[ -z "${MANAGER_URL:-}" ]]; then
  echo "ERROR: SITE_ID and MANAGER_URL must be set in /etc/environment" >&2
  exit 1
fi

# Configuration file to manage
export CONF_FILE=/etc/nginx/nginx.conf

# URL to fetch configuration from
export CONF_URL=${MANAGER_URL}/sites/${SITE_ID}/nginx.conf

# Command to test configuration validity before applying
export TEST_COMMAND="nginx -t"

# Command to reload the service
export RELOAD_COMMAND="nginx -s reload"

# Fallback service name for systemctl (if RELOAD_COMMAND fails)
export SERVICE_NAME="nginx"

# Execute pull-config
exec /opt/opensource-server/pull-config/bin/pull-config

